Trading Parameters:
Symbol: {{ symbol }}
Current Price: {{ current_price }}
Budget: {{ budget }} USDT
Leverage: {{ leverage }}x

{% if volatility_metrics %}
# Volatility Analysis by Timeframe

4H Timeframe (Context):
- ATR: {{ volatility_metrics.metrics['4H'].atr }}
- ATR Percentile: {{ volatility_metrics.metrics['4H'].atr_percentile }}
- Normalized ATR: {{ volatility_metrics.metrics['4H'].normalized_atr }}
- BB Width: {{ volatility_metrics.metrics['4H'].bb_width }}
- BB Width Percentile: {{ volatility_metrics.metrics['4H'].bb_width_percentile }}
- Volatility Change 24h: {{ volatility_metrics.metrics['4H'].volatility_change_24h }}
{#- Direction Score: {{ volatility_metrics.metrics['4H'].direction_score }}#}
{#- Opportunity Score: {{ volatility_metrics.metrics['4H'].opportunity_score }}#}
{#- Current Regime: {{ volatility_metrics.metrics['4H'].regime }}#}

1H Timeframe :
- ATR: {{ volatility_metrics.metrics['1H'].atr }}
- ATR Percentile: {{ volatility_metrics.metrics['1H'].atr_percentile }}
- Normalized ATR: {{ volatility_metrics.metrics['1H'].normalized_atr }}
- BB Width: {{ volatility_metrics.metrics['1H'].bb_width }}
- BB Width Percentile: {{ volatility_metrics.metrics['1H'].bb_width_percentile }}
- Volatility Change 24h: {{ volatility_metrics.metrics['1H'].volatility_change_24h }}
{#- Direction Score: {{ volatility_metrics.metrics['1H'].direction_score }}#}
{#- Opportunity Score: {{ volatility_metrics.metrics['1H'].opportunity_score }}#}
{#- Current Regime: {{ volatility_metrics.metrics['1H'].regime }}#}

15m Timeframe (Entry):
- ATR: {{ volatility_metrics.metrics['15m'].atr }}
- ATR Percentile: {{ volatility_metrics.metrics['15m'].atr_percentile }}
- Normalized ATR: {{ volatility_metrics.metrics['15m'].normalized_atr }}
- BB Width: {{ volatility_metrics.metrics['15m'].bb_width }}
- BB Width Percentile: {{ volatility_metrics.metrics['15m'].bb_width_percentile }}
- Volatility Change 24h: {{ volatility_metrics.metrics['15m'].volatility_change_24h }}
{#- Direction Score: {{ volatility_metrics.metrics['15m'].direction_score }}#}
{#- Opportunity Score: {{ volatility_metrics.metrics['15m'].opportunity_score }}#}
{#- Current Regime: {{ volatility_metrics.metrics['15m'].regime }}#}

{#Overall Opportunity Analysis:#}
{#{% set primary_score = volatility_metrics.metrics[atr_timeframe].opportunity_score %}#}
{#{% set primary_direction = volatility_metrics.metrics[atr_timeframe].direction_score %}#}
{#{% set other_scores = [] %}#}
{#{% for tf, metrics in volatility_metrics.metrics.items() %}#}
{#    {% if tf != atr_timeframe and (metrics.direction_score * primary_direction > 0) %}#}
{#        {% set _ = other_scores.append(metrics.opportunity_score) %}#}
{#    {% endif %}#}
{#{% endfor %}#}
{#{% set confirmation_score = (other_scores|sum / other_scores|length) if other_scores|length > 0 else 0 %}#}
{#{% set overall_score = (primary_score * 0.7 + confirmation_score * 0.3) %}#}
{#- Primary Score ({{ atr_timeframe }}): {{ "%.2f"|format(primary_score) }}#}
{#- Timeframe Confirmation: {{ "%.2f"|format(confirmation_score) }}#}
{#- Overall Opportunity: {{ "%.2f"|format(overall_score) }}#}

{#Trading Context Interpretation:#}
{##}
{#1. Volatility Regime:#}
{#   - LOW (vol_score < 25): Market showing minimal volatility#}
{#   - MEDIUM (vol_score 25-50): Normal market conditions#}
{#   - HIGH (vol_score 50-75): Elevated volatility conditions#}
{#   - EXTREME (vol_score > 75): Exceptional volatility levels#}
{##}
{#2. Opportunity Score Interpretation:#}
{#   - High (>50): Strong alignment between volatility and direction#}
{#     * Indicates strong trend with supporting volatility#}
{#     * Optimal conditions for position entry#}
{#     * Size positions according to confidence level#}
{##}
{#   - Medium (20-50): Moderate alignment#}
{#     * Market shows coherent movement but requires validation#}
{#     * Consider partial position sizing#}
{#     * Confirm with additional signals#}
{##}
{#   - Low (<20): Weak alignment#}
{#     * Could indicate:#}
{#       a) Low volatility in a clear direction (trending calmly)#}
{#       b) High volatility with unclear direction (choppy market)#}
{#       c) Both low volatility and unclear direction#}
{#     * Focus on position management rather than new entries#}
{#     * Reduce position sizes or wait for better conditions#}
{##}
{#3. Direction Score Impact (-100 to +100):#}
{#   - Magnitude indicates trend strength#}
{#   - Sign indicates direction (positive = upward, negative = downward)#}
{#   - Values near zero suggest unclear direction regardless of volatility#}
{##}
{#Trading Response:#}
{#- Combine regime and opportunity score for decision making#}
{#- Higher opportunity scores in MEDIUM regime may be preferable to lower scores in HIGH regime#}
{#- EXTREME regime requires additional risk management regardless of opportunity score#}
{% endif %}

{% if current_positions %}
Current Positions:
{% for position in current_positions %}
- Symbol: {{ position.symbol }}
  Side: {{ position.side }}
  Size: {{ position.size }}
  Entry Price: {{ position.entry_price }}
  Leverage: {{ position.leverage }}
  Unrealized PNL: {{ position.unrealized_pnl }}
  Take Profit: {{ position.take_profit }}
  Created: {{ position.created_time }}

Note: Stop losses are managed automatically by the system based on {{ atr_timeframe }} ATR.
{% endfor %}
{% endif %}

{% if existing_orders %}
Current Active Orders:
{% for order in existing_orders %}
- Order ID: {{ order.id }}
  Link ID: {{ order.order_link_id }}
  Type: {{ order.type }}
  Side: {{ order.side }}
  Price: {{ order.price }}
  Quantity: {{ order.qty }}
  Status: {{ order.status }}
  Created: {{ order.created_time }}
  Take Profit: {{ order.take_profit }}
{% endfor %}


Order Cancellation Requirements:
1. For EACH order to be cancelled, you MUST provide:
   - The exchange's order ID as the 'id' field (from 'Order ID' in active orders)
   - Optionally include the order_link_id (from 'Link ID' in active orders)
   - Both IDs must be copied EXACTLY as shown in the active orders list
2. The 'symbol' field must match the order being cancelled
3. The 'reason' field must explain the technical justification for cancellation
4. Example of a valid cancellation:
  {
    "id": "1234567890",        // Exact Order ID from active orders
    "order_link_id": "abc123", // Optional, exact Link ID from active orders
    "symbol": "BTCUSDT",       // Must match the order's symbol
    "reason": "Direction score reversed from entry premise, opportunity score below threshold"
  }
{% endif %}